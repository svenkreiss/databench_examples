{% extends "templates/analysis.html" %}

{% block title %}mpld3Drag{% end %}


{% block content %}
[[ include_md('mpld3Drag/README.md') ]]
<div id="mpld3canvas"></div>
<pre id="log"></pre>
{% end %}


{% block footerscripts %}
<script>
  mpld3.register_plugin("drag", DragPlugin);
  DragPlugin.prototype = Object.create(mpld3.Plugin.prototype);
  DragPlugin.prototype.constructor = DragPlugin;
  DragPlugin.prototype.requiredProps = ["idpts", "idline", "idpatch"];
  DragPlugin.prototype.defaultProps = {}
  function DragPlugin(fig, props){
      mpld3.Plugin.call(this, fig, props);
  };

  DragPlugin.prototype.draw = function(){
      var patchobj = mpld3.get_element(this.props.idpatch, this.fig);
      var ptsobj = mpld3.get_element(this.props.idpts, this.fig);
      var lineobj = mpld3.get_element(this.props.idline, this.fig);

      var drag = d3.behavior.drag()
          .origin(function(d) { return {x:ptsobj.ax.x(d[0]),
                                        y:ptsobj.ax.y(d[1])}; })
          .on("dragstart", dragstarted)
          .on("drag", dragged)
          .on("dragend", dragended);

      lineobj.path.attr("d", lineobj.datafunc(ptsobj.offsets));
      patchobj.path.attr("d", patchobj.datafunc(ptsobj.offsets,
                                                patchobj.pathcodes));
      lineobj.data = ptsobj.offsets;
      patchobj.data = ptsobj.offsets;

      ptsobj.elements()
         .data(ptsobj.offsets)
         .style("cursor", "default")
         .call(drag);

      function dragstarted(d) {
        d3.event.sourceEvent.stopPropagation();
        d3.select(this).classed("dragging", true);
      }

      function dragged(d, i) {
        d[0] = ptsobj.ax.x.invert(d3.event.x);
        d[1] = ptsobj.ax.y.invert(d3.event.y);
        d3.select(this)
          .attr("transform", "translate(" + [d3.event.x,d3.event.y] + ")");
        lineobj.path.attr("d", lineobj.datafunc(ptsobj.offsets));
        patchobj.path.attr("d", patchobj.datafunc(ptsobj.offsets,
                                                  patchobj.pathcodes));
      }

      function dragended(d, i) {
        d3.select(this).classed("dragging", false);
      }
  }

  mpld3.register_plugin("drag", DragPlugin);


  var databench = Databench();
</script>
{% end %}
